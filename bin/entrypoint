#!/usr/bin/with-contenv bash
# shellcheck shell=bash

set -e
export RAILS_ENV=production
export PATH="/opt/mastodon/bin:/bin:/usr/bin:/usr/sbin:/usr/local/bin:${PATH}"
export PROGRAM="$1"

/opt/mastodon/bin/start-sshd
/opt/mastodon/bin/start-nginx

/opt/mastodon/bin/show-branding

if [[ $PROGRAM == "mastodon" ]]; then
    /opt/mastodon/bin/show-mastodon-branding
    /opt/mastodon/bin/start-mastodon 
elif [[ $PROGRAM == "sidekiq" ]]; then
    /opt/mastodon/bin/show-sidekiq-branding
    /opt/mastodon/bin/start-sidekiq 
elif [[ $PROGRAM == "streaming" ]]; then
    /opt/mastodon/bin/show-streaming-branding
    /opt/mastodon/bin/start-streaming 
elif [[ $PROGRAM == "all" ]]; then
    /opt/mastodon/bin/show-mastodon-branding
    /opt/mastodon/bin/start-mastodon 
    /opt/mastodon/bin/show-sidekiq-branding
    /opt/mastodon/bin/start-sidekiq 
    /opt/mastodon/bin/show-mastodon-branding
    /opt/mastodon/bin/start-streaming 
else
    /bin/echo "Program '${PROGRAM}' was not found and could not be started.";
fi