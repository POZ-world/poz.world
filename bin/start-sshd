#!/usr/bin/with-contenv bash
# shellcheck shell=bash

export RAILS_ENV=production
export PATH="/opt/mastodon/bin:/usr/bin:/bin:${PATH}"

/bin/bash show-sshd-branding

if /usr/bin/pgrep -f "sshd:" >/dev/null; then
    /bin/echo "Zombie sshd processes detected, sending SIGTERM"
    /usr/bin/pkill -ef sshd:
    csleep 1
fi

if /usr/bin/pgrep -f "sshd:" >/dev/null; then
    /bin/echo "Zombie sshd processes still active, sending SIGKILL"
    /usr/bin/pkill -9 -ef sshd:
    /bin/sleep 1
fi

/usr/sbin/sshd -D
